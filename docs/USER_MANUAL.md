# ProvChainOrg User Manual

Welcome to the ProvChainOrg User Manual. This guide provides step-by-step instructions for running the system, submitting supply chain data, and querying the blockchain.

## Table of Contents

1.  [Getting Started](#getting-started)
2.  [Running the System](#running-the-system)
3.  [Generating an API Key](#generating-an-api-key)
4.  [Submitting Transactions](#submitting-transactions)
5.  [Querying Data](#querying-data)
6.  [Validating the Blockchain](#validating-the-blockchain)
7.  [Troubleshooting](#troubleshooting)

---

## 1. Getting Started

### Prerequisites

*   **Docker** and **Docker Compose** installed on your machine.
*   Basic familiarity with the command line.

---

## 2. Running the System

We provide a Docker-based deployment that sets up a fully functional 3-node blockchain network.

### Step 1: Deploy the Nodes

1.  Navigate to the `deploy/` directory:
    ```bash
    cd deploy
    ```

2.  Start the network using Docker Compose:
    ```bash
    docker-compose -f docker-compose.3node.yml up -d --build
    ```

    This will start:
    *   **Node 1**: `http://localhost:8080`
    *   **Node 2**: `http://localhost:8081`
    *   **Node 3**: `http://localhost:8082`
    *   **Monitoring Stack**: Prometheus, Grafana, Jaeger.

3.  Verify the nodes are running:
    ```bash
    docker ps
    ```
    You should see `provchain-node1`, `provchain-node2`, `provchain-node3` in the list.

4.  Check the status of Node 1:
    ```bash
    curl http://localhost:8080/api/status
    ```

---

## 3. Generating an API Key

To interact with the system (submit data or query), you need an API Key (JWT Token).

Since you are running via Docker, execute the following command to generate a key from **Node 1**:

```bash
    docker exec -it provchain-node1 provchain-org generate-api-key
```

*Save the output string. This is your `YOUR_API_KEY`.*

---

## 4. Submitting Transactions

In ProvChainOrg, a "transaction" is the submission of RDF data (Turtle format) describing a supply chain event.

### Endpoint
*   **URL**: `http://localhost:8080/api/data`
*   **Method**: `POST`
*   **Content-Type**: `text/turtle`

### Example: Creating a Product Batch

Save the following content to a file named `batch_data.ttl`:

```turtle
@prefix : <http://example.org/supply-chain#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

:Batch001 a :ProductBatch ;
    :hasBatchID "BATCH-001" ;
    :product :OrganicTomatoes ;
    :harvestDate "2025-01-14"^^xsd:date ;
    :originFarm :GreenValleyFarm .
```

Submit it using `curl`:

```bash
curl -X POST http://localhost:8080/api/data \
  -H "Content-Type: text/turtle" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -d @batch_data.ttl
```

**Success Response:**
```json
{
  "success": true,
  "data": {
    "block_index": 1,
    "block_hash": "0x...",
    "timestamp": "..."
  }
}
```

---

## 5. Querying Data

You can query the blockchain using SPARQL.

### Endpoint
*   **URL**: `http://localhost:8080/api/query`
*   **Method**: `POST`
*   **Content-Type**: `application/sparql-query`

### Example: Finding All Products

Submit the following SPARQL query:

```bash
curl -X POST http://localhost:8080/api/query \
  -H "Content-Type: application/sparql-query" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -d '
    PREFIX : <http://example.org/supply-chain#>
    SELECT ?batch ?product ?farm WHERE {
        ?batch a :ProductBatch ;
               :product ?product ;
               :originFarm ?farm .
    }
  '
```

**Response:**
```json
{
  "success": true,
  "data": {
    "results": [
      {
        "batch": "http://example.org/supply-chain#Batch001",
        "product": "http://example.org/supply-chain#OrganicTomatoes",
        "farm": "http://example.org/supply-chain#GreenValleyFarm"
      }
    ]
  }
}
```

---

## 6. Validating the Blockchain

To ensure data integrity and verify that all nodes are in sync.

### Endpoint
*   **URL**: `http://localhost:8080/api/validate`
*   **Method**: `POST`

### Command

```bash
curl -X POST http://localhost:8080/api/validate \
  -H "Authorization: Bearer YOUR_API_KEY"
```

**Response:**
```json
{
  "success": true,
  "data": {
    "is_valid": true,
    "total_blocks": 2
  }
}
```

---

## 7. Troubleshooting

### Connection Refused
*   Ensure Docker containers are running: `docker ps`.
*   Check if ports 8080, 8081, 8082 are occupied by other services.

### Authentication Failed
*   Ensure you are using the exact token generated by the `generate-api-key` command.
*   Ensure you included the `Bearer ` prefix in the Authorization header.

### Invalid RDF Data
*   The system validates RDF syntax. Ensure your Turtle (`.ttl`) format is correct.
*   Check prefixes (`@prefix`) are correctly defined.

### System Logs
To view logs for a specific node (e.g., Node 1):
```bash
docker logs -f provchain-node1
```

